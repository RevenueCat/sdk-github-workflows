name: Claude Code Review

on:
  workflow_call:
    inputs:
      model:
        description: 'Claude model to use (e.g., claude-sonnet-4-20250514, claude-opus-4-5-20251101)'
        required: false
        type: string
        default: ''
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      GITHUB_TOKEN_SPECS:
        description: 'GitHub token with access to RevenueCat/sdk-specs (optional, for spec-checking)'
        required: false
jobs:
  claude-review:
    if: |
      (
        github.event.pull_request.author_association == 'OWNER' ||
        github.event.pull_request.author_association == 'MEMBER' ||
        github.event.pull_request.author_association == 'COLLABORATOR' ||
        github.event.pull_request.author_association == 'CONTRIBUTOR'
      ) &&
      !github.event.pull_request.draft

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Check write access
        run: |
          PERMISSION=$(gh api repos/${{ github.repository }}/collaborators/${{ github.event.pull_request.user.login }}/permission --jq .permission)
          if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "write" ]]; then
            echo "✓ User has write access (permission: $PERMISSION)"
          else
            echo "✗ User does not have write access (permission: $PERMISSION)"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN_SPECS || github.token }}
          plugin_marketplaces: 'https://github.com/anthropics/claude-code.git'
          plugins: 'code-review@claude-code-plugins'
          prompt: '/code-review:code-review ${{ github.repository }}/pull/${{ github.event.pull_request.number }}'
          claude_args: >-
            ${{ inputs.model != '' && format('--model {0}', inputs.model) || '' }}
            --append-system-prompt "CRITICAL: Before reviewing, check if the PR description contains any links to https://github.com/RevenueCat/sdk-specs. If found: 1) Use gh api to fetch all files in the linked spec directory (design.md, spec.md, tasks.md), 2) Read and understand the spec requirements, 3) Verify the implementation matches the spec, 4) Call out any missing requirements or deviations from the spec, 5) Check if the Android equivalent PR (if linked) follows similar patterns."
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
